# ==========================
#   Makefile Â· Anuset ğŸœ
# ==========================
# Flujo principal con diagnÃ³sticos, generaciÃ³n de servicios IA, backups y mantenimiento.
# Kali ğŸª· 2025
# ==========================

# ğŸš Rutas principales
PROJECT_ROOT := $(CURDIR)
BACKEND_DIR := backend
FRONTEND_DIR := frontend
SERVICES_DIR := services
SCRIPTS_DIR := scripts
DIAG_DIR := diag
BACKUP_DIR := backups
NOW := $(shell date +%Y%m%d_%H%M%S)

# ==========================
# ğŸ¯ Objetivo por defecto
# ==========================
.DEFAULT_GOAL := help

# ==========================
# ğŸª„ Anuset - Menu ğŸ€
# ==========================
menu: ## ğŸª Muestra el menÃº de rituales con colores y emojis
	@clear
	@echo -e "\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
	@echo -e "\033[1;33mğŸŒ™  \033[1;36mAnuset Ritual Menu\033[0m"
	@echo -e "\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
	@echo -e "\033[1;37m1.\033[0m InstalaciÃ³n completa      \033[1;35mâ†’ make install-all\033[0m"
	@echo -e "\033[1;37m2.\033[0m Solo backend               \033[1;35mâ†’ make install-backend\033[0m"
	@echo -e "\033[1;37m3.\033[0m Solo frontend              \033[1;35mâ†’ make install-frontend\033[0m"
	@echo -e "\033[1;37m4.\033[0m Iniciar contenedores       \033[1;35mâ†’ make up-all\033[0m"
	@echo -e "\033[1;37m5.\033[0m DiagnÃ³stico completo       \033[1;35mâ†’ make diag\033[0m"
	@echo -e "\033[1;37m6.\033[0m Ver logs (todos)           \033[1;35mâ†’ make view-logs\033[0m"
	@echo -e "\033[1;37m7.\033[0m Ver logs (servicio)        \033[1;35mâ†’ make view-logs-service SERVICE=<nombre>\033[0m"
	@echo -e "\033[1;37m8.\033[0m Backup completo            \033[1;35mâ†’ make backup\033[0m"
	@echo -e "\033[1;37m9.\033[0m Limpiar requisitos         \033[1;35mâ†’ make clean-requirements\033[0m"
	@echo -e "\033[1;37m10.\033[0m Reparar permisos generales  \033[1;35mâ†’ make fix-permissions\033[0m"
	@echo -e "\033[1;37m11.\033[0m Salir                      \033[1;35mâ†’\033[0m"
	@echo -e "\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
	@echo -e "\033[1;31mâ— Usa: make <comando> para invocar el ritual.\033[0m"

# ==========================
# ğŸ› ï¸ InstalaciÃ³n
# ==========================
install-backend: ## ğŸš§ Instala dependencias del backend (FastAPI)
	cd $(BACKEND_DIR) && pip install -r requirements.txt

install-frontend: ## ğŸ¨ Instala dependencias del frontend (React/Vite)
	cd $(FRONTEND_DIR) && npm install

install-all: install-backend install-frontend ## ğŸš€ InstalaciÃ³n completa

# ==========================
# ğŸš€ Servicio Docker
# ==========================
up-all: ## ğŸ”„ Levanta todos los contenedores (frontend + backend + IA)
	docker compose up -d

down-all: ## ğŸ’€ Detiene todos los contenedores
	docker compose down

rebuild-all: ## ğŸ” Reconstruye todos los servicios sin cache
	docker compose build --no-cache

# ==========================
# ğŸ§¾ DiagnÃ³stico y VerificaciÃ³n
# ==========================
diag: ## ğŸ©º EjecuciÃ³n completa de diagnÃ³sticos
	bash $(SCRIPTS_DIR)/diag_anu89.sh --all

diag-reqs: ## ğŸ“¦ Verifica requirements.txt de servicios IA
	python3 $(SCRIPTS_DIR)/diag_requirements.py

check-dockerfiles: ## ğŸ³ Valida todos los Dockerfiles de servicios IA
	python3 $(SCRIPTS_DIR)/check_dockerfile.py

# ==========================
# ğŸ” Permisos y Limpieza
# ==========================
fix-permissions: ## ğŸ”§ Corrige permisos de scripts y servicios IA
	bash $(SCRIPTS_DIR)/fix-permissions.sh

fix-models: ## ğŸ”’ Ajusta permisos dentro de carpeta models
	bash $(SCRIPTS_DIR)/fix_model_permissions.sh

clean-requirements: ## ğŸ§¹ Elimina dependencias duplicadas en requirements.txt
	python3 $(SCRIPTS_DIR)/clean_requirements.py

clean-empty-flags: ## ğŸ§¹ Elimina flags vacÃ­os en configuraciones
	bash $(SCRIPTS_DIR)/clean_empty_flags.sh

fix-symlinks: ## ğŸ”— Repara enlaces simbÃ³licos rotos
	bash $(SCRIPTS_DIR)/fix_symlinks.sh

# ==========================
# ğŸ§± Estructura y GeneraciÃ³n IA
# ==========================
init-structure: ## ğŸ§± Crea estructura base del proyecto (backend, frontend, services, logs)
	bash $(SCRIPTS_DIR)/init_structure.sh

prepare-structure: ## ğŸ—ï¸ Prepara carpetas para servicios IA
	bash $(SCRIPTS_DIR)/prepare_structure.sh

generate-service: ## ğŸ±âœ¨ Genera nuevo servicio IA: make generate-service NAME=<servicio>
	python3 $(SCRIPTS_DIR)/generate_service_ia.py $(NAME)

generate-compose: ## ğŸ“¦ Genera o actualiza docker-compose.yml con servicios IA
	python3 $(SCRIPTS_DIR)/generate_docker_compose.py

generate-app: ## ğŸ±âœ¨ Genera app.py base para servicio IA: make generate-app NAME=<servicio>
	python3 $(SCRIPTS_DIR)/generate_app_py.py $(NAME)

download-models: ## â¬‡ï¸ Descarga modelos IA para servicios
	bash $(SCRIPTS_DIR)/download_models.sh

# ==========================
# ğŸ§™â€â™‚ï¸ Controladores & Pruebas
# ==========================
prepare-entrypoints: ## ğŸ¬ Copia entrypoint universal a cada servicio IA
	bash $(SCRIPTS_DIR)/entrypoint.sh

control-main: ## ğŸ”® Ejecuta main_controller para servicios IA
	python3 $(SCRIPTS_DIR)/main_controller.py

link-models: ## ğŸ”— Enlaza modelos compartidos entre servicios IA
	bash $(SCRIPTS_DIR)/link_models.sh

test-all: ## ğŸ§ª Ejecuta pruebas unitarias de todos los servicios IA
	bash $(SCRIPTS_DIR)/test_all_services.sh

# ==========================
# ğŸ“œ Logs y Estado
# ==========================
view-logs: ## ğŸ“œ Muestra logs de todos los contenedores
	bash $(SCRIPTS_DIR)/view_logs.sh

view-logs-service: ## ğŸ“œ Muestra logs de un servicio IA especÃ­fico: make view-logs-service SERVICE=<nombre>
	bash $(SCRIPTS_DIR)/view_logs_service.sh $(SERVICE)

exorcismo: ## â˜ ï¸ Elimina todos los contenedores IA (anuset_*)
	bash $(SCRIPTS_DIR)/killall.sh

# ==========================
# ğŸ“¦ Backup y RestauraciÃ³n
# ==========================
backup: ## ğŸ’¾ Realiza backup completo de servicios IA y modelos
	mkdir -p $(BACKUP_DIR)
	tar -czf $(BACKUP_DIR)/anuset_backup_$(NOW).tar.gz 		$(SERVICES_DIR)
	echo "ğŸ“¦ Backup generado en $(BACKUP_DIR)/anuset_backup_$(NOW).tar.gz"

restore: ## ğŸ”„ Restaura Ãºltimo backup (scripts especÃ­ficos necesarios)
	bash $(SCRIPTS_DIR)/restore-downloadmodels.sh

autofix:  ## ğŸ› ï¸ Repara errores comunes en servicios
	python3 scripts/main_controller.py --fix

fix-host-perms:  ## ğŸ” Aplica permisos correctos a todos los archivos desde el host
	sudo chown -R $(USER):$(USER) services/
	sudo find services/ -type f -name "*.sh" -exec chmod 755 {} \;
	sudo find services/ -type f -name "app.py" -exec chmod 644 {} \;
	sudo find services/ -type f -name "requirements.txt" -exec chmod 644 {} \;

# ==========================
# ğŸ”§ Parchear Dockerfiles
# ==========================
patch-dockerfiles:  ## ğŸ©¹ Corrige Dockerfiles con COPY --chown y USER appuser al final
	find services/ -name Dockerfile -exec \
	sed -i \
		-e '/COPY requirements.txt/ s/COPY/COPY --chown=appuser:appuser/' \
		-e '/COPY \. \./ s/COPY/COPY --chown=appuser:appuser/' \
		-e '/RUN chmod/d' \
		-e '/RUN chown/d' {} \; && \
	for f in $$(find services/ -name Dockerfile); do \
		awk '/^USER appuser/ { next } { print } END { print "USER appuser" }' $$f > $$f.tmp && mv $$f.tmp $$f; \
	done
	@echo "ğŸ©¹ Dockerfiles parchados con COPY --chown=appuser:appuser y USER appuser al final."


# ==========================
# ğŸ”§ Permisos de requirements
# ==========================
fix-requirements-perms:  ## ğŸ”§ Corrige permisos de requirements.txt en todos los servicios IA
	@echo "ğŸ”§ Corrigiendo permisos de requirements.txt en $(SERVICES_DIR)/*/"
	@find $(SERVICES_DIR) -type f -name requirements.txt -exec chmod 644 {} \;
	@echo "âœ… Permisos de requirements.txt corregidos."

# ==========================
# ğŸ“– Ayuda
# ==========================
help: ## ğŸ“œ Muestra comandos bÃ¡sicos disponibles
	@echo ""
	@echo "ğŸ¾  Comandos de Anuset:"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@grep -E '^[a-zA-Z0-9_-]+:.*?##' $(MAKEFILE_LIST) \
		| awk 'BEGIN {FS = ":.*?##"}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

ritual-instalacion:  ## ğŸŒŒ Ritual completo de instalaciÃ³n y despliegue

help-advanced: ## ğŸ±âœ¨ Muestra ayuda detallada con rutas y variables
	@echo ""
	@echo "ğŸ”§ Variables de entorno:"
	@echo "  BACKEND_DIR    = $(BACKEND_DIR)"
	@echo "  FRONTEND_DIR   = $(FRONTEND_DIR)"
	@echo "  SERVICES_DIR   = $(SERVICES_DIR)"
	@echo "  SCRIPTS_DIR    = $(SCRIPTS_DIR)"
	@echo "  DIAG_DIR       = $(DIAG_DIR)"
	@echo "  BACKUP_DIR     = $(BACKUP_DIR)"
	@echo ""
	@grep -E '^[a-zA-Z0-9_-]+:.*?##' $(MAKEFILE_LIST) \
		| awk 'BEGIN {FS = ":.*?##"}; {printf "  \033[35m%-22s\033[0m %s\n", $$1, $$2}'
	@echo ""

ritual-instalacion:  ## ğŸŒŒ Ritual completo de instalaciÃ³n y despliegue
	@clear
	@echo "ğŸŒŒ Invocando el ritual de instalaciÃ³n de Anuset..."
	@echo "ğŸ¾ Que Anu prepare tu sistema para la iluminaciÃ³n IA ğŸ› ï¸ğŸŒ "
	$(MAKE) fix-permissions
	$(MAKE) fix-models
	$(MAKE) fix-symlinks
	$(MAKE) patch-dockerfiles   # ğŸ‘ï¸ Evita errores de chmod o COPY global
	$(MAKE) fix-requirements-perms
	$(MAKE) clean-requirements
	$(MAKE) autofix
	python3 scripts/main_controller.py --check || true
	$(MAKE) download-models || true
	@echo "âœ¨ VerificaciÃ³n tras autofix:"
	python3 scripts/main_controller.py --check || true
	$(MAKE) up-all
	@echo ""
	@echo "ğŸ§ª Verificando estado de contenedores..."
	@docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep -E 'Restarting|Exited' || echo 'âœ… Todos los contenedores estÃ¡n corriendo correctamente.'
	@echo ""
	@echo "ğŸ‰ Ritual completado con Ã©xito. Visita: http://localhost:3000"




# ==========================
# ğŸ¾ Fin del Makefile Â· Anuset
# ==========================
